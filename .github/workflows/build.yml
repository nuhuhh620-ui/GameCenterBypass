name: Build Dylib (Aggressive Cancel)

on: [push]

jobs:
  build:
    runs-on: macos-latest
    env:
      THEOS: ${{ github.workspace }}/theos

    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          brew install ldid make xz

      - name: Install Theos
        run: |
          git clone --depth 1 --recursive https://github.com/theos/theos.git $THEOS

      - name: Get iOS SDK
        run: |
          mkdir -p $THEOS/sdks
          cd $THEOS/sdks
          curl -L -o sdk.tar.xz https://github.com/theos/sdks/releases/download/14.5/iPhoneOS14.5.sdk.tar.xz || true
          
          FILE_SIZE=$(wc -c < sdk.tar.xz | xargs)
          if [ "$FILE_SIZE" -gt 10000000 ]; then
              tar -xf sdk.tar.xz
              rm sdk.tar.xz
          else
              rm -f sdk.tar.xz
              git clone --depth 1 https://github.com/theos/sdks.git temp_sdks
              mv temp_sdks/iPhoneOS14.5.sdk .
              rm -rf temp_sdks
          fi

      - name: Generate Aggressive Source Code
        run: |
          # --- 1. MAKEFILE ---
          echo "TARGET := iphone:clang:14.5:14.0" > Makefile
          echo "ARCHS = arm64" >> Makefile
          echo "GameCenterBypass_FRAMEWORKS = GameKit Foundation UIKit" >> Makefile
          echo "include \$(THEOS)/makefiles/common.mk" >> Makefile
          echo "" >> Makefile
          echo "TWEAK_NAME = GameCenterBypass" >> Makefile
          echo "GameCenterBypass_FILES = Tweak.x" >> Makefile
          echo "GameCenterBypass_CFLAGS = -fobjc-arc" >> Makefile
          echo "" >> Makefile
          echo "include \$(THEOS_MAKE_PATH)/tweak.mk" >> Makefile

          # --- 2. CONTROL FILE --- 
          echo "Package: com.ios.gamecenterbypass" > control
          echo "Name: GameCenterBypass" >> control
          echo "Version: 1.0.0" >> control
          echo "Architecture: iphoneos-arm" >> control
          echo "Description: Aggressive Fix" >> control
          echo "Maintainer: Me" >> control
          echo "Author: Me" >> control
          echo "Section: Tweaks" >> control

          # --- 3. TWEAK.X (THE LOGIC) ---
          echo "#import <Foundation/Foundation.h>" > Tweak.x
          echo "#import <UIKit/UIKit.h>" >> Tweak.x
          echo "#import <GameKit/GameKit.h>" >> Tweak.x
          echo "" >> Tweak.x
          echo "@interface GKLocalPlayer (Private)" >> Tweak.x
          echo "-(void)cancelAuthentication;" >> Tweak.x
          echo "@end" >> Tweak.x
          echo "" >> Tweak.x
          echo "%hook GKLocalPlayer" >> Tweak.x
          echo "" >> Tweak.x
          echo "// 1. YOUR ORIGINAL METHOD" >> Tweak.x
          echo "-(void)setAuthStartTimeStamp:(double)timestamp {" >> Tweak.x
          echo "    if ([self respondsToSelector:@selector(cancelAuthentication)]) {" >> Tweak.x
          echo "        [self cancelAuthentication];" >> Tweak.x
          echo "    }" >> Tweak.x
          echo "    %orig;" >> Tweak.x
          echo "}" >> Tweak.x
          echo "" >> Tweak.x
          echo "// 2. THE BLACK SCREEN SAVER" >> Tweak.x
          echo "// If the game waits for a login result, give it a 'User Cancelled' error instantly." >> Tweak.x
          echo "-(void)setAuthenticateHandler:(void (^)(UIViewController *viewController, NSError *error))handler {" >> Tweak.x
          echo "    if (handler) {" >> Tweak.x
          echo "        NSError *err = [NSError errorWithDomain:NSCocoaErrorDomain code:NSUserCancelledError userInfo:nil];" >> Tweak.x
          echo "        handler(nil, err);" >> Tweak.x
          echo "    }" >> Tweak.x
          echo "}" >> Tweak.x
          echo "" >> Tweak.x
          echo "%end" >> Tweak.x
          echo "" >> Tweak.x
          echo "%ctor {" >> Tweak.x
          echo "    NSLog(@\"[GCBypass] Initialized\");" >> Tweak.x
          echo "    " >> Tweak.x
          echo "    // 3. THE REPEATED ATTACK (BACKGROUND TIMER)" >> Tweak.x
          echo "    // This runs in the background and tries to cancel login every 2 seconds for 1 minute." >> Tweak.x
          echo "    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{" >> Tweak.x
          echo "        for (int i = 0; i < 30; i++) {" >> Tweak.x
          echo "            [NSThread sleepForTimeInterval:2.0];" >> Tweak.x
          echo "            " >> Tweak.x
          echo "            // Run the cancel command on the main thread safely" >> Tweak.x
          echo "            dispatch_async(dispatch_get_main_queue(), ^{" >> Tweak.x
          echo "                GKLocalPlayer *player = [GKLocalPlayer localPlayer];" >> Tweak.x
          echo "                if ([player respondsToSelector:@selector(cancelAuthentication)]) {" >> Tweak.x
          echo "                    [player cancelAuthentication];" >> Tweak.x
          echo "                    NSLog(@\"[GCBypass] Auto-Cancelling... (Attempt %d)\", i);" >> Tweak.x
          echo "                }" >> Tweak.x
          echo "            });" >> Tweak.x
          echo "        }" >> Tweak.x
          echo "    });" >> Tweak.x
          echo "}" >> Tweak.x

      - name: Build Dylib
        run: |
          make -j1 DEBUG=0 FINALPACKAGE=1 messages=yes

      - name: Find and Move Dylib
        run: |
          find . -name "*.dylib" -exec mv {} ./ \;
          ls -la *.dylib

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameCenterBypass-Dylib
          path: "*.dylib"
