name: Build and Locate Dylib

on: [push]

jobs:
  build:
    runs-on: macos-latest
    env:
      THEOS: ${{ github.workspace }}/theos

    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          brew install ldid make xz

      - name: Install Theos
        run: |
          git clone --depth 1 --recursive https://github.com/theos/theos.git $THEOS

      - name: Get iOS SDK
        run: |
          mkdir -p $THEOS/sdks
          cd $THEOS/sdks
          curl -L -o sdk.tar.xz https://github.com/theos/sdks/releases/download/14.5/iPhoneOS14.5.sdk.tar.xz || true
          
          FILE_SIZE=$(wc -c < sdk.tar.xz | xargs)
          if [ "$FILE_SIZE" -gt 10000000 ]; then
              tar -xf sdk.tar.xz
              rm sdk.tar.xz
          else
              rm -f sdk.tar.xz
              git clone --depth 1 https://github.com/theos/sdks.git temp_sdks
              mv temp_sdks/iPhoneOS14.5.sdk .
              rm -rf temp_sdks
          fi

      - name: Build Dylib
        run: |
          # Build using single core
          make -j1 DEBUG=0 FINALPACKAGE=1 messages=yes

      - name: Find and Move Dylib
        run: |
          echo "Searching for dylib files..."
          # Find any .dylib file in the entire folder structure and print it
          find . -name "*.dylib"
          
          # Move the found dylib to the current main directory
          find . -name "*.dylib" -exec mv {} ./ \;
          
          # Verify it is now in the main folder
          echo "Files in root directory:"
          ls -la *.dylib

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameCenterBypass-Dylib
          # Now we just upload from the main folder (no hidden paths)
          path: "*.dylib"
