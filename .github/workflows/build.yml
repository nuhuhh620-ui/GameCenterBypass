name: Build Dylib (Optimized)

on: [push]

jobs:
  build:
    runs-on: macos-latest
    env:
      THEOS: ${{ github.workspace }}/theos

    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          brew install ldid make

      - name: Install Theos
        run: |
          # Clone Theos without full history (saves time/memory)
          git clone --depth 1 --recursive https://github.com/theos/theos.git $THEOS

      - name: Download SDK (Lightweight)
        run: |
          # Download iOS 14.5 SDK
          curl -L -o sdk.zip https://github.com/xybp888/iOS-SDKs/releases/download/iOS-14.5/iPhoneOS14.5.sdk.zip
          mkdir -p $THEOS/sdks
          unzip -q sdk.zip -d $THEOS/sdks/
          # Fix folder name
          mv $THEOS/sdks/iPhoneOS14.5.sdk $THEOS/sdks/iPhoneOS14.5.sdk 2>/dev/null || true
          rm sdk.zip

      - name: Build Dylib
        run: |
          # OPTIMIZATION:
          # 1. -j1: Uses only 1 CPU core to prevent crashing
          # 2. DEBUG=0: Removes heavy debug symbols
          # 3. no 'package': Stops after making the dylib
          make -j1 DEBUG=0 FINALPACKAGE=1 messages=yes

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameCenterBypass-Dylib
          path: .theos/obj/debug/*.dylib
