name: Build Dylib (Final Fix)

on: [push]

jobs:
  build:
    # UPDATED: Using macos-latest (macOS 15 Apple Silicon) to fix runner errors
    runs-on: macos-latest

    env:
      THEOS: ${{ github.workspace }}/theos
      # PREVENT ERRORS: Tell the compiler to ignore some strict warnings
      GO_EASY_ON_ME: 1

    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          # Install only the essentials for compiling
          brew install ldid make

      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $THEOS

      - name: Download iOS SDK
        run: |
          # Use a stable, high-speed mirror for the SDK
          curl -L -o sdk.zip https://github.com/xybp888/iOS-SDKs/releases/download/iOS-14.5/iPhoneOS14.5.sdk.zip
          mkdir -p $THEOS/sdks
          unzip -q sdk.zip -d $THEOS/sdks/
          # Ensure the folder name is exactly what Theos expects
          mv $THEOS/sdks/iPhoneOS14.5.sdk $THEOS/sdks/iPhoneOS14.5.sdk 2>/dev/null || true
          rm sdk.zip

      - name: Generate Source Files
        run: |
          # --- 1. MAKEFILE ---
          echo "TARGET := iphone:clang:14.5:14.0" > Makefile
          echo "ARCHS = arm64" >> Makefile
          # We need to explicitly list frameworks to avoid linker errors
          echo "GameCenterBypass_FRAMEWORKS = GameKit Foundation UIKit" >> Makefile
          echo "include \$(THEOS)/makefiles/common.mk" >> Makefile
          echo "" >> Makefile
          echo "TWEAK_NAME = GameCenterBypass" >> Makefile
          echo "GameCenterBypass_FILES = Tweak.x" >> Makefile
          echo "GameCenterBypass_CFLAGS = -fobjc-arc" >> Makefile
          echo "" >> Makefile
          echo "include \$(THEOS_MAKE_PATH)/tweak.mk" >> Makefile

          # --- 2. CONTROL FILE --- 
          # (Required by Theos logic even if we don't package)
          echo "Package: com.hack.gcbypass" > control
          echo "Name: GameCenterBypass" >> control
          echo "Version: 1.0.0" >> control
          echo "Architecture: iphoneos-arm" >> control
          echo "Description: Bypass" >> control
          echo "Maintainer: Me" >> control
          echo "Author: Me" >> control
          echo "Section: Tweaks" >> control

          # --- 3. TWEAK.X CODE ---
          echo "#import <Foundation/Foundation.h>" > Tweak.x
          echo "#import <UIKit/UIKit.h>" >> Tweak.x
          echo "#import <GameKit/GameKit.h>" >> Tweak.x
          echo "#import <dlfcn.h>" >> Tweak.x
          echo "" >> Tweak.x
          # Hook declaration
          echo "%hook GKLocalPlayer" >> Tweak.x
          echo "-(void)setAuthStartTimeStamp:(double)timestamp {" >> Tweak.x
          echo "    // Attempt to cancel authentication" >> Tweak.x
          echo "    @try {" >> Tweak.x
          echo "        if ([self respondsToSelector:@selector(cancelAuthentication)]) {" >> Tweak.x
          echo "             [self performSelector:@selector(cancelAuthentication)];" >> Tweak.x
          echo "        }" >> Tweak.x
          echo "    } @catch (NSException *e) {}" >> Tweak.x
          echo "    %orig;" >> Tweak.x
          echo "}" >> Tweak.x
          echo "%end" >> Tweak.x
          echo "" >> Tweak.x
          echo "%ctor {" >> Tweak.x
          echo "    NSLog(@\"[GameCenterBypass] Loaded\");" >> Tweak.x
          echo "}" >> Tweak.x

      - name: Build Dylib Only
        run: |
          # CRITICAL FIX: 
          # We run ONLY 'make'. We do NOT run 'make package'.
          # This compiles the code but skips the 'dpkg-deb' step that causes Exit Code 9.
          make messages=yes

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameCenterBypass-Dylib
          # The file is generated here by the 'make' command
          path: .theos/obj/debug/*.dylib
