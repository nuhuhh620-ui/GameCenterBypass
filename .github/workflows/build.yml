name: Build Dylib (Fixed SDK)

on: [push]

jobs:
  build:
    runs-on: macos-latest
    env:
      THEOS: ${{ github.workspace }}/theos

    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          brew update
          # install xz so we can handle .tar.xz, plus existing tools
          brew install ldid make xz

      - name: Install Theos
        run: |
          git clone --depth 1 --recursive https://github.com/theos/theos.git $THEOS

      - name: Download SDK (Official) - robust
        run: |
          set -euo pipefail

          SDK_URL="https://github.com/theos/sdks/releases/download/14.5/iPhoneOS14.5.sdk.tar.xz"
          SDK_FILE="iPhoneOS14.5.sdk.tar.xz"
          DEST="$THEOS/sdks"

          mkdir -p "$DEST"

          # Download with retries and fail on HTTP errors (prevents saving HTML error pages)
          echo "Downloading $SDK_URL"
          curl -fL --retry 3 --retry-delay 5 -o "$SDK_FILE" "$SDK_URL"

          # Basic validation
          if [ ! -s "$SDK_FILE" ]; then
            echo "::error::Downloaded SDK is empty or missing. Check $SDK_URL"
            ls -l "$SDK_FILE" || true
            exit 1
          fi

          echo "Downloaded file info:"
          ls -lh "$SDK_FILE"
          file "$SDK_FILE" || true

          # Try to extract directly with tar -xJf, fallback to xz -d then tar -xf
          if tar -xJf "$SDK_FILE" -C "$DEST/"; then
            echo "Extracted SDK with tar -xJf"
          else
            echo "tar -xJf failed, trying xz -d then tar -xf"
            xz -d -f "$SDK_FILE"   # produces .tar
            tar -xf "${SDK_FILE%.xz}" -C "$DEST/"
          fi

          # Cleanup downloaded archives
          rm -f "$SDK_FILE" "${SDK_FILE%.xz}" || true

      - name: Build Dylib
        run: |
          # Use Single Core (-j1) to prevent memory crashes
          make -j1 DEBUG=0 FINALPACKAGE=1 messages=yes

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameCenterBypass-Dylib
          path: .theos/obj/debug/*.dylib
