name: Build Dylib (Bulletproof)

on: [push]

jobs:
  build:
    runs-on: macos-latest
    env:
      THEOS: ${{ github.workspace }}/theos

    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          brew install ldid make xz

      - name: Install Theos
        run: |
          git clone --depth 1 --recursive https://github.com/theos/theos.git $THEOS

      - name: Get iOS SDK (Smart Method)
        run: |
          # 1. Define the target folder
          mkdir -p $THEOS/sdks
          cd $THEOS/sdks
          
          # 2. Try to download the official compressed SDK (Fast method)
          echo "Attempting fast download..."
          curl -L -o iPhoneOS14.5.sdk.tar.xz https://github.com/theos/sdks/releases/download/14.5/iPhoneOS14.5.sdk.tar.xz || true
          
          # 3. Verify if the file is valid (larger than 10MB)
          FILE_SIZE=$(wc -c < iPhoneOS14.5.sdk.tar.xz | xargs)
          if [ "$FILE_SIZE" -gt 10000000 ]; then
              echo "Download successful. Extracting..."
              tar -xf iPhoneOS14.5.sdk.tar.xz
              rm iPhoneOS14.5.sdk.tar.xz
          else
              echo "Fast download failed (File too small or 404). Switching to Fallback..."
              rm -f iPhoneOS14.5.sdk.tar.xz
              
              # 4. Fallback: Clone the SDK repository (Slow but Guaranteed)
              git clone --depth 1 https://github.com/theos/sdks.git temp_sdks
              mv temp_sdks/iPhoneOS14.5.sdk .
              rm -rf temp_sdks
          fi
          
          # 5. Final check to ensure SDK exists
          if [ -d "iPhoneOS14.5.sdk" ]; then
              echo "SDK installed successfully!"
          else
              echo "::error::Critical Failure: SDK could not be obtained."
              exit 1
          fi

      - name: Build Dylib
        run: |
          # Use -j1 to prevent Memory Crash (Exit Code 9)
          make -j1 DEBUG=0 FINALPACKAGE=1 messages=yes

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameCenterBypass-Dylib
          path: .theos/obj/debug/*.dylib
