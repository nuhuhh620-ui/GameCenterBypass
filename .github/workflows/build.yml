name: Build Dylib (Path Fix)

on: [push]

jobs:
  build:
    runs-on: macos-latest
    env:
      THEOS: ${{ github.workspace }}/theos

    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          brew install ldid make xz

      - name: Install Theos
        run: |
          git clone --depth 1 --recursive https://github.com/theos/theos.git $THEOS

      - name: Get iOS SDK
        run: |
          # 1. Setup SDK folder
          mkdir -p $THEOS/sdks
          cd $THEOS/sdks
          
          # 2. Download SDK
          curl -L -o sdk.tar.xz https://github.com/theos/sdks/releases/download/14.5/iPhoneOS14.5.sdk.tar.xz || true
          
          # 3. Extract (Checking size to ensure it's not a 404 error)
          FILE_SIZE=$(wc -c < sdk.tar.xz | xargs)
          if [ "$FILE_SIZE" -gt 10000000 ]; then
              tar -xf sdk.tar.xz
              rm sdk.tar.xz
          else
              # Fallback if download fails
              rm -f sdk.tar.xz
              git clone --depth 1 https://github.com/theos/sdks.git temp_sdks
              mv temp_sdks/iPhoneOS14.5.sdk .
              rm -rf temp_sdks
          fi

      - name: Build Dylib
        run: |
          # Compiling with standard settings
          make -j1 DEBUG=0 FINALPACKAGE=1 messages=yes

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GameCenterBypass-Dylib
          # FIX: This wildcard (**) searches every folder for the dylib
          path: .theos/**/*.dylib
